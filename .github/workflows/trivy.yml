name: Container Vulnerability Scan (Trivy)

on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]
    paths:
      - "src/**"
      - "tests/**"
      - "main.py"
      - "pyproject.toml"
      - "uv.lock"
      - "container/**"
      - "scripts/**"
      - "Makefile"
      - ".trivyignore.yaml"
      - ".github/workflows/trivy.yml"
  push:
    branches: [ main ]
    paths:
      - "src/**"
      - "tests/**"
      - "main.py"
      - "pyproject.toml"
      - "uv.lock"
      - "container/**"
      - "scripts/**"
      - "Makefile"
      - ".trivyignore.yaml"
      - ".github/workflows/trivy.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write

jobs:
  image-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install Podman
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Build images
        run: |
          set -euo pipefail
          CONTAINER_COMMAND=podman make build

      - name: Install Trivy
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y wget gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | \
            gpg --dearmor | \
            sudo tee /usr/share/keyrings/trivy.gpg > /dev/null
          echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | \
            sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy
          trivy --version

      - name: Scan images (sequential, Podman)
        run: |
          set -euo pipefail
          mkdir -p trivy-results
          images=(ffreis/base ffreis/base-builder ffreis/builder ffreis/base-runner ffreis/runner)

          # Warm DB once.
          trivy image --download-db-only --no-progress

          for image in "${images[@]}"; do
            name="${image##*/}"
            archive="trivy-results/${name}.oci.tar"

            podman image exists "${image}"
            podman save --format oci-archive --output "${archive}" "${image}"

            trivy image \
              --input "${archive}" \
              --skip-db-update \
              --no-progress \
              --ignorefile .trivyignore.yaml \
              --scanners vuln \
              --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
              --ignore-unfixed \
              --exit-code 0 \
              --format sarif \
              --output "trivy-results/${name}.sarif"
            test -s "trivy-results/${name}.sarif"

            trivy image \
              --input "${archive}" \
              --skip-db-update \
              --no-progress \
              --ignorefile .trivyignore.yaml \
              --scanners vuln \
              --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
              --ignore-unfixed \
              --exit-code 0 \
              --format json \
              --output "trivy-results/${name}.json"
            test -s "trivy-results/${name}.json"

            echo "Full vulnerability report for ${image} (all severities):"
            trivy image \
              --input "${archive}" \
              --skip-db-update \
              --no-progress \
              --ignorefile .trivyignore.yaml \
              --scanners vuln \
              --severity UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL \
              --ignore-unfixed \
              --exit-code 0 \
              --format table

            echo "Gating ${image} on HIGH/CRITICAL vulnerabilities..."
            trivy image \
              --input "${archive}" \
              --skip-db-update \
              --no-progress \
              --ignorefile .trivyignore.yaml \
              --scanners vuln \
              --severity HIGH,CRITICAL \
              --ignore-unfixed \
              --exit-code 1 \
              --format table
          done

      - name: Upload Trivy JSON reports
        uses: actions/upload-artifact@v4
        with:
          name: trivy-json-reports
          path: trivy-results/*.json
          if-no-files-found: error

      - name: Upload Trivy SARIF (per image)
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false }}
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(trivy-results/*.sarif)
          if [ ${#files[@]} -eq 0 ]; then
            echo "::warning::No Trivy SARIF files found to upload."
            exit 0
          fi
          failures=0
          for f in "${files[@]}"; do
            name="$(basename "$f" .sarif)"
            echo "Uploading $f with category trivy-$name"
            sarif_payload="$(gzip -c "$f" | base64 | tr -d '\n')"
            if ! response="$(gh api \
              -X POST \
              /repos/${{ github.repository }}/code-scanning/sarifs \
              -f sarif="${sarif_payload}" \
              -f commit_sha="${{ github.sha }}" \
              -f ref="${{ github.ref }}" 2>&1)"; then
              failures=$((failures + 1))
              echo "::warning title=Trivy SARIF upload failed::${f}: ${response}"
              continue
            fi
            echo "${response}"
          done
          if [ "$failures" -gt 0 ]; then
            echo "::warning::${failures} Trivy SARIF upload(s) failed; vulnerability scan results were still generated."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
